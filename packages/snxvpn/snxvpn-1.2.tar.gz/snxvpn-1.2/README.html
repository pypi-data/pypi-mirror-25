<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.13.1: http://docutils.sourceforge.net/" />
<title>SNX-VPN</title>
<style type="text/css">

/*
:Author: David Goodger
:Contact: goodger@users.sourceforge.net
:Date: $Date: 2007-12-21 16:51:22 +0100 (Fri, 21 Dec 2007) $
:Version: $Revision: 4316 $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.
*/

/* "! important" is used here to override other ``margin-top`` and
   ``margin-bottom`` styles that are later in the stylesheet or 
   more specific.  See <http://www.w3.org/TR/CSS1#the-cascade>. */
.first {
  margin-top: 0 ! important }

.last {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

a.reference img {
  border-width: 0px ;
  }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em }

div.footer, div.header {
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin-left: 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font-family: serif ;
  font-size: 100% }

pre.line-block {
  font-family: serif ;
  font-size: 100% }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em ;
  background-color: #eeeeee }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

table.citation {
  border-left: solid thin gray }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid thin black }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

th.docinfo-name, th.field-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

tt.docutils {
  background-color: #eeeeee }

ul.auto-toc {
  list-style-type: none }

body {
  background-color: #F0F0FF }

p img {
  vertical-align: text-top }


</style>
</head>
<body>
<div class="document" id="snx-vpn">
<h1 class="title">SNX-VPN</h1>

<p>By Ralf Schlatterbeck</p>
<p>This is a project to connect to a Checkpoint SSL-VPN from a Linux
client. The current version of checkpoint SNX (SSL Network Extender) for
Linux no longer supports a command-line mode. The supported version
involves a Browser with Java and is heavily dependent on the correct
Java version and other configuration options in the Browser. Moreover it
seems to only work with the Mozilla browsers (Firefox) not with others
like Chrome. Last not least Java and the Browser like to die frequently.</p>
<p>The current Checkpoint solution still depends on a command-line utility
called <tt class="docutils literal">snx</tt> that needs root privileges and is installed either via
automatic download (and install) from Java or by hand. The web-page for
the SSL-VPN usually supports download of the correct snx-version for
that endpoint for manual installation.</p>
<p>In the new solution the <tt class="docutils literal">snx</tt> binary is called with the undocumented
<tt class="docutils literal"><span class="pre">-Z</span></tt> Option. In that mode it does not do the password negotiation
(which is done via the browser) but is only used for setting up the VPN
connection.</p>
<p>This project is an attempt to duplicate the Browser-based login with a
standalone program (in python) to get rid of all the Java version and
Browser intergration headache. We still rely on the <tt class="docutils literal">snx</tt> binary by
Checkpoint which is called with the undocumented <tt class="docutils literal"><span class="pre">-Z</span></tt> option.</p>
<p>So far this is working for me with a Checkpoint SSL that uses username
and password authentication and in addition a one-time password
transmitted via SMS to the telephone of the person trying to connect.
If you're using certificate-based login or other methods, this will
probably not work for you out-of-the-box but you may want to help me
make it work.</p>
<div class="section" id="install-and-run">
<h1>Install and Run</h1>
<p>Install via <tt class="docutils literal">pip</tt> is the preferred way (replace <tt class="docutils literal">pip</tt> with <tt class="docutils literal">pip3</tt>
if you want to install for python3):</p>
<pre class="literal-block">
pip install snxvpn
</pre>
<p>The following dependencies are needed but should be picked up
automagically if you install via <tt class="docutils literal">pip</tt>:</p>
<ul class="simple">
<li>Beautiful Soup version 4 (<tt class="docutils literal"><span class="pre">python-bs4</span></tt> Debian package)</li>
<li>pycrypto (<tt class="docutils literal"><span class="pre">python-crypto</span></tt> Debian package)</li>
</ul>
<p>After installation you should be able to run <tt class="docutils literal">snxconnect <span class="pre">--help</span></tt> to
find out about options. At least a host, and username must be given,
either on the command-line via options or in a config file (see below).</p>
<p>The <tt class="docutils literal">snxconnect</tt> program will currently create two files in the
current working directory where the program is started:</p>
<ul class="simple">
<li><tt class="docutils literal">snxanswer</tt>: The not-yet-reverse-engineered answer of Checkpoint's
<tt class="docutils literal">snx</tt> program to the caller, only created if the <tt class="docutils literal"><span class="pre">--debug</span></tt> option
is given</li>
<li><tt class="docutils literal"><span class="pre">$HOME/.snxcookies</span></tt>: The cookies from the remote end in the format known
from the perl LWP library (available in python as LWPCookieJar), this
is only created if the <tt class="docutils literal"><span class="pre">--save-cookies</span></tt> option is given. The default
cookie filename can be changed with the <tt class="docutils literal"><span class="pre">--cookiefile</span></tt> option.</li>
</ul>
<p>If a cookie file is found, <tt class="docutils literal">snxconnect</tt> tries to reconnect without
asking for a password. This can be used if the connection has died
prematurely before the connection time ran out. And, yes, it might be a
security risk to save cookies to disk, so you have to explicitly enable
this feature by setting <tt class="docutils literal"><span class="pre">save-cookies</span> true</tt> in the config file or
giving the <tt class="docutils literal"><span class="pre">--save-cookies</span></tt> option. Note that the cookies of course
only have a limited lifetime and your connection isn't very secure if
you cannot be sure of the files on your disk. Moreover all users of the
current machine can access the VPN connection anyway.</p>
<p>When you run Checkpoints <tt class="docutils literal">snx</tt> for the first time with <tt class="docutils literal">snxconnect</tt> it
creates an X-Windows popup that lets you confirm the server fingerprint.
I've not seen this popup with the Java framework (but Java died several
times during my first experiments which is one of the reasons I wrote
<tt class="docutils literal">snxvpn</tt>, so that might be the reason I hadn't seen the popup
before).  You have to confirm this popup. The server fingerprint is
stored into a file with extension <tt class="docutils literal">.db</tt> in <tt class="docutils literal">/etc/snx</tt>.</p>
<p>For configuration, <tt class="docutils literal">snxconnect</tt> accepts a config file
<tt class="docutils literal"><span class="pre">$HOME/.snxvpnrc</span></tt>. The options there are the command-line long options
(obtained with --help) where a '-' is replaced with '_'.  For
compatibility with <tt class="docutils literal">.snxrc</tt>, the keyword <tt class="docutils literal">server</tt> is an alias for
<tt class="docutils literal">host</tt>. You can see which options were picked up from the config-file
by specifying <tt class="docutils literal"><span class="pre">--help</span></tt>, where defaults are displayed, the defaults
from the config-file are displayed. Command-line options take precedence
over config-file entries.</p>
<p>In addition a <tt class="docutils literal">.netrc</tt> file is supported that can contain username and
password by host name. Note that storing long-term login credentials on
disk is a security risk. See the manual page for <tt class="docutils literal">netrc</tt> for further
details.</p>
<p>To install from source (from a <tt class="docutils literal">git</tt> checkout) you need my
<a class="reference external" href="https://sourceforge.net/projects/sfreleasetools/">sfreleasetools</a> from Sourceforge. This adds the necessary <tt class="docutils literal">Makefile</tt>
includes to create the <tt class="docutils literal">snxvpnversion.py</tt> from the git tag containing
the latest version number. You can either install <a class="reference external" href="https://sourceforge.net/projects/sfreleasetools/">sfreleasetools</a> in a
sibling directory of <tt class="docutils literal">snxvpn</tt> called <tt class="docutils literal">releasetools</tt> or set the
environment variable RELEASETOOLS pointing to your cloned version.
You also need the <tt class="docutils literal">rst2html</tt> command provided by <tt class="docutils literal">docutils</tt>, on
Debian Linux you can obtain it by installing the <tt class="docutils literal"><span class="pre">python-docutils</span></tt>
package.</p>
<p>Once this is installed, call <tt class="docutils literal">make</tt> without arguments. This will
create the <tt class="docutils literal">snxvpnversion.py</tt> which is used by the <tt class="docutils literal">setup.py</tt>
script.</p>
<p>Once the snxvpnversion.py has been created, the <tt class="docutils literal">snxvpn</tt> package can
be installed with normal:</p>
<pre class="literal-block">
python setup.py install --prefix=/usr/local
</pre>
</div>
<div class="section" id="notes-on-snx-installation">
<h1>Notes on <tt class="docutils literal">snx</tt> Installation</h1>
<p>From many posts on various mailinglists and forums, it is clear that
installing <tt class="docutils literal">snx</tt> isn't straightforward. You need some non-standard
libraries installed that <tt class="docutils literal">snx</tt> needs to function. Moreover <tt class="docutils literal">snx</tt> is
a binary for the <tt class="docutils literal">i386</tt> architecture, not a modern 64-bit AMD/Intel
architecture. I can only give hints for Debian installation here but the
general steps will apply to other distributions, too.</p>
<p>Obtaining the snx binary in the first place can usually be achieved by
connecting via web-browser to the SSL-VPN site via the browser, log in
and (in my installation here at least) look in the <em>Settings</em> (in german
<em>Einstellungen</em>) menu for an entry native application settings or
similar (german &quot;Native Anwendungseinstellungen bearbeiten&quot;). In this
menu I do have links for manual download of <tt class="docutils literal">snx</tt> for Linux and
Mac-OS.</p>
<p>First of all if you're on a 64-bit architecture (called <tt class="docutils literal"><span class="pre">amd-64</span></tt> at
least by Debian) you need to enable multi-architecture support with:</p>
<pre class="literal-block">
dpkg --add-architecture i386
apt-get update
</pre>
<p>Then you need to install some packages that contain libraries needed by
<tt class="docutils literal">snx</tt>, notably:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">libstdc++5:i386</span></tt></li>
<li><tt class="docutils literal">libxcb1:i386</tt></li>
<li><tt class="docutils literal">libaudit1:i386</tt></li>
<li><tt class="docutils literal">libgcc1:i386</tt></li>
<li><tt class="docutils literal">libxau6:i386</tt></li>
<li><tt class="docutils literal">libxdmcp6:i386</tt></li>
</ul>
<p>To check if you have all necessary libraries, you can run <tt class="docutils literal">ldd</tt> on the
<tt class="docutils literal">snx</tt> binary (with sudo to root):</p>
<pre class="literal-block">
sudo ldd /usr/bin/snx
</pre>
<p>This should list a library file for each line and should not report any
missing libraries.</p>
</div>
<div class="section" id="some-notes-on-the-mechanisms">
<h1>Some Notes on the Mechanisms</h1>
<p>This section discusses some of the internals of how the <tt class="docutils literal">snx</tt> program
is called by the Java framework and <tt class="docutils literal">snxconnect</tt>.</p>
<p>The Login process via the browser is a standard login page with lots of
Javascript and redirects. Passwords are sent in encrypted form to the
VPN gateway. The encryption uses a 2048 bit RSA key and pads the
password with random data before encryption (this is <em>good</em>). During
login the browser (or this program) picks up a lot of cookies and can
access necessary login information via Javascript. This information
includes:</p>
<ul class="simple">
<li>RSA public key for the password encryption</li>
<li>Username to be passed to <tt class="docutils literal">snx</tt></li>
<li>A one-time password (different from the one received via telephone) to
be passed to <tt class="docutils literal">snx</tt></li>
<li>Host name for TLS connection</li>
<li>Port for TLS connection</li>
<li>A server fingerprint</li>
</ul>
<p>All these (except the RSA key) are passed to the <tt class="docutils literal">snx</tt> program for
establishing the connection. The connection might use PPP internally as
some of the error messages (which are sent as part of the i18n info in
Javascript and map the error codes of <tt class="docutils literal">snx</tt> to human-readable
messages) suggest.</p>
<p>If you call <tt class="docutils literal">snx</tt> with the undocumented <tt class="docutils literal"><span class="pre">-Z</span></tt> option by hand, it
will terminate immediately. It obviously has other checks in place if it
is called &quot;correctly&quot;.  To call <tt class="docutils literal">snx</tt> correctly with this option,
<tt class="docutils literal">snx</tt> expects that standard input, output and error are UNIX pipes.
Only if something goes wrong and <tt class="docutils literal">snx</tt> dies with an error-message,
these pipes are ever used. After startup, <tt class="docutils literal">snx</tt> checks the existence
of a logfile and creates it if it doesn't exist or is not locked by
another <tt class="docutils literal">snx</tt> process. Then it creates some other lockfiles in
<tt class="docutils literal">/etc/snx/tmp</tt> and then immediately forks a child process and lets the
parent process terminate. This forking and terminating sends the child
process to the background. The first step the child process does is
close the file-descriptors for standard input, output, and error.</p>
<p>After this, <tt class="docutils literal">snx</tt> opens and listens on a TCP socket on port 7776 on
the local machine. I haven't found options for telling <tt class="docutils literal">snx</tt> to use
another port. The calling application (e.g., <tt class="docutils literal">snxconnect</tt> or the
original Java framework) is expected to pass the connection information
detailed above in an undocumented binary format. After that <tt class="docutils literal">snx</tt>
establishes a VPN connection and reports back with another blob of
binary information on the same socket. The socket must then be kept open
by the calling application, otherwise <tt class="docutils literal">snx</tt> terminates. It may well be
that <tt class="docutils literal">snx</tt> accepts further commands on that socket, e.g., for renewing
the authentication after the VPN timeout has expired. We log the binary
data received on that socket to the file <tt class="docutils literal">snxanswer</tt> if debugging is
enabled.</p>
</div>
</div>
</body>
</html>
