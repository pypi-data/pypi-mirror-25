{% extends "layout.html" %}
{% from "macros.html" import list_out, list_out_bytes, igv_link, igv_open_file, ucsc_link, genemania_single_link, ensemble_link, all_link %}
{% block caption %}{% endblock %}
{% block title %}SNP{% endblock %}


{% block body %}
    <div class="row left">
    <div class="columns small-12 medium-8 large-8">
        <ul class="accordion" data-accordion="myAccordionGroup" style="margin-left:0px">
            <li class="accordion-navigation">
                <a href="#panel1c">Parameters</a>
                <div id="panel1c" class="content">
                    <div class="small-12 medium-12 large-12 columns left">
                        <table>
                            <thead>
                                <tr><th>Name</th><th>Value</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Case</td>
                                    <td>
                                        {% for sample in query.case %}
                                        {{ sample }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Case Groups</td>
                                    <td>
                                        {% for group in query.case_groups %}
                                        {{ group }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Control</td>
                                    <td>
                                        {% for sample in query.control %}
                                        {{ sample }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Control Groups</td>
                                    <td>
                                        {% for group in query.control_groups %}
                                        {{ group }}{% if not loop.last %}, {% endif %}
                                        {% endfor %}
                                    </td>
                                </tr>
                                <tr>
                                    <td>Reference Genome</td>
                                    <td>{%- if query.usehg19 -%}hg19{% else %}hg38{% endif %}</td>
                                </tr>
                                <tr>
                                    <td>min Qual</td>
                                    <td>{{ query.min_qual }}</td>
                                </tr>
                                <tr>
                                    <td>min Samples per Gene</td>
                                    <td>{{ query.min_samples_per_gene }}</td>
                                </tr>
                                <tr>
                                    <td>min Samples per Variant</td>
                                    <td>{{ query.min_samples_per_variant }}</td>
                                </tr>
                                <tr>
                                    <td>min Variants per Gene</td>
                                    <td>{{ query.min_variants_per_gene }}</td>
                                </tr>
                            </tbody>
                        </table>    
                    </div>
                </div>
            </li>
        </ul>
	</div>
    <button class="columns right small-12 medium-1 large-1 exportbutton" onclick="$(table2excel).toCSV('recessive.csv')">.csv</button>
	<button class="columns right small-12 medium-1 large-1" id="exportbutton" onclick="tableToExcel('table2excel', 'snp.xls')">.xls</button>
    <a href="data:text/plain;base64,{{ vcf|safe }}" download="snp.vcf" class="button columns right small-12 medium-1 large-1" >.vcf</a>
    </div>

    <div class="row left">
    <table class="datatable" id="table2excel" style="margin-top: 20px;">
    <thead>
        <tr>
            <th></th>
            <th>#</th>
            <th>RSID</th>
            <th>Symbol</th>
            <th>C</th>
            <th>Samples</th>
            <th>Effect</th>
            <th>Het</th>
            <th>Alt</th>
            <th>Qual</th>
            <th>AF</th>
            <th>Location</th>
            <th>Impact</th>
            <th>IGV</th>
            <th>UCSC</th>
            <th>1000G (HG19)</th>
            <th>OMIM</th>
            <th>ExAC (HG19)</th>
        </tr>
    </thead>
    <tbody>
    {% for r in results %}
        <tr>
            <td><a href="{{ url_for('variant_detail', chrom=r.chrom, position=r.position, typ=r.typ, sample=r.samples | single_element) }}">+</a></td>
            <td>{{ loop.index }}</td>
            <td>{{ r.rsid | rsid }}</td>
            <td>
            {% for symbol in r.symbols %}
                {% set s = symbol.decode() %}
                {{ ensemble_link(s) }}{% if not loop.last %}, {% endif %}
            {% endfor %}
            </td>
            <td>{{ r.common | length }}</td>
            <td>
            {% for s in r.samples %}
                <span title = "Heterozygosity: {{ "het" if r.heterozygot[s] else "hom" }}, Quality: {{ r.qual[s] }}">
                {{ igv_open_file('bam' + "/" + s + '.bam', s) }}
                </span>
                {% if not loop.last %}, {% endif %}
            {% endfor %}{{ list_out() }}
            </td>
            <td>{{ r.effect|effects }}</td>
            <td>{{ r.rowheterozygot|heterozygosity}}</td>
            {% if r.typ < 4 %}
                <td>{{ r.ref }}>{{ "ACGT"[r.typ] }}</td>
            {% else %}
                <td></td>
            {% endif %}
            <td>{{ r.maxqual }}</td>
            <td>{{ (r.minaf) | round(2) }} - {{ (r.maxaf) | round(2) }}</td>
            <td>{{ r.chrom }}:{{ r.position }}</td>
            <td>{{ ["MODIFIER", "LOW", "MODERATE", "HIGH"][r.maximpact] }}</td>
            {{ all_link(r.chrom, r.position, r.ref, "ACGT"[r.typ], None, r.symbols, query.usehg19) }}
        </tr>
    {% endfor%}
    </tbody>
    </table>
    </div>
{% endblock %}

