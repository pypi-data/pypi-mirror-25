<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>cis_interface.drivers.RMQDriver &#8212; cis_interface 0.0.0 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.0.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for cis_interface.drivers.RMQDriver</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">pika</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="k">import</span> <span class="n">pformat</span>
<span class="kn">from</span> <span class="nn">cis_interface.drivers.Driver</span> <span class="k">import</span> <span class="n">Driver</span>
<span class="kn">from</span> <span class="nn">cis_interface.drivers.IODriver</span> <span class="k">import</span> <span class="n">maxMsgSize</span>
<span class="kn">from</span> <span class="nn">cis_interface.config</span> <span class="k">import</span> <span class="n">cis_cfg</span>
<span class="kn">from</span> <span class="nn">cis_interface</span> <span class="k">import</span> <span class="n">backwards</span>


<div class="viewcode-block" id="RMQDriver"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver">[docs]</a><span class="k">class</span> <span class="nc">RMQDriver</span><span class="p">(</span><span class="n">Driver</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Class for handling basic RabbitMQ communications.</span>

<span class="sd">    Args:</span>
<span class="sd">        name (str): The name of the driver.</span>
<span class="sd">        queue (str, optional): Name of the queue that messages will be</span>
<span class="sd">            received from. If and empty string, the queue is exclusive to this</span>
<span class="sd">            connection. Defaults to &#39;&#39;.</span>
<span class="sd">        routing_key (str, optional): Routing key that should be used when the</span>
<span class="sd">            queue is bound. If None, the queue name is used. Defaults to None.</span>
<span class="sd">        user (str, optional): RabbitMQ server username. Defaults to config</span>
<span class="sd">            option &#39;user&#39; in section &#39;rmq&#39;.</span>
<span class="sd">        host (str, optional): RabbitMQ server host. Defaults to config option</span>
<span class="sd">            &#39;host&#39; in section &#39;rmq&#39; if it exists and the output of</span>
<span class="sd">            socket.gethostname() if it does not.</span>
<span class="sd">        vhost (str, optional): RabbitMQ server virtual host. Defaults to</span>
<span class="sd">            config option &#39;vhost&#39; in section &#39;rmq&#39;.</span>
<span class="sd">        passwd (str, optional): RabbitMQ server password. Defaults to</span>
<span class="sd">            config option &#39;password&#39; in section &#39;rmq&#39;.</span>
<span class="sd">        exchange (str, optional): RabbitMQ exchange. Defaults to &#39;namespace&#39;</span>
<span class="sd">            attribute which is set from the config option &#39;namespace&#39; in the</span>
<span class="sd">            section &#39;rmq&#39;.</span>
<span class="sd">        exclusive (bool, optional): If True, the queue that is created can</span>
<span class="sd">            only be used by this driver. Defaults to False. If a queue</span>
<span class="sd">            name is not provided, it is assumed exclusive.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        user (str): RabbitMQ server username.</span>
<span class="sd">        passwd (str): RabbitMQ server password.</span>
<span class="sd">        host (str): RabbitMQ server host.</span>
<span class="sd">        vhost (str): RabbitMQ server virtual host.</span>
<span class="sd">        exchange (str): RabbitMQ exchange name.</span>
<span class="sd">        connection (:class:`pika.Connection`): RabbitMQ connection.</span>
<span class="sd">        channel (:class:`pika.Channel`): RabbitMQ channel.</span>
<span class="sd">        queue (str): Name of the queue that messages will be received</span>
<span class="sd">            from. If an empty string, the queue is exclusive to this</span>
<span class="sd">            connection.</span>
<span class="sd">        routing_key (str): Routing key that should be used when the queue is</span>
<span class="sd">            bound. If None, the queue name is used.</span>
<span class="sd">        times_connected (int): Number of times the connection has been</span>
<span class="sd">            established/re-established.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">kwattr</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;passwd&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="s1">&#39;vhost&#39;</span><span class="p">,</span> <span class="s1">&#39;exchange&#39;</span><span class="p">,</span> <span class="s1">&#39;exclusive&#39;</span><span class="p">]</span>
        <span class="n">kwargs_attr</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwattr</span><span class="p">}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RMQDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">cis_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmq&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">cis_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmq&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vhost</span> <span class="o">=</span> <span class="n">cis_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmq&#39;</span><span class="p">,</span> <span class="s1">&#39;vhost&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span> <span class="o">=</span> <span class="n">cis_cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;rmq&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exchange</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">namespace</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwattr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">kwargs_attr</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs_attr</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">))</span>
            <span class="c1"># if getattr(self, k) is None:  # pragma: debug</span>
            <span class="c1">#     raise Exception((&quot;%s not provided and corresponding &quot; +</span>
            <span class="c1">#                      &quot;environment variable is not set.&quot;) % k)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span> <span class="o">=</span> <span class="n">routing_key</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">consumer_tag</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opening</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times_connected</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setDaemon</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q_obj</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># def __del__(self):</span>
    <span class="c1">#     self.debug(&#39;~&#39;)</span>
    <span class="c1">#         if self.connection is not None:</span>
    <span class="c1">#             self.connection.close()</span>
    <span class="c1">#         self.connection = None</span>
    <span class="c1">#     except:</span>
    <span class="c1">#         self.debug(&quot;::__del__(): exception&quot;)</span>

    <span class="c1"># DRIVER FUNCTIONALITY</span>
<div class="viewcode-block" id="RMQDriver.start"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Start the driver. Waiting for connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_opening</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RMQDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opening</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
            <span class="n">timeout</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleeptime</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opening</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Connection never finished opening.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.run"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Run the driver. Connect to the connection and begin the IO loop.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RMQDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;::run&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;::run returns&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.terminate"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.terminate">[docs]</a>    <span class="k">def</span> <span class="nf">terminate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Terminate the driver by closing the RabbitMQ connection.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="k">return</span>  <span class="c1"># Don&#39;t close more than once</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;::terminate&quot;</span><span class="p">)</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opening</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Waiting for connection to open before terminating&#39;</span><span class="p">)</span>
                <span class="c1"># if self.connection is None:</span>
                <span class="c1">#     self.connection.add_timeout(self.terminate(), self.sleeptime)</span>
                <span class="c1">#     return</span>
                <span class="c1"># while self.connection is None:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
                <span class="n">timeout</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleeptime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::terminate: Closing connection&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop_communication</span><span class="p">()</span>
        <span class="c1"># Only needed if ioloop is stopped prior to closing the connection?</span>
        <span class="c1"># (e.g. keyboard interupt)</span>
        <span class="c1"># if self.connection:</span>
        <span class="c1">#     self.connection.ioloop.start()</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RMQDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::terminate returns&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.get_message_stats"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.get_message_stats">[docs]</a>    <span class="k">def</span> <span class="nf">get_message_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Return message stats from the server.&quot;&quot;&quot;</span>
        <span class="n">hoststr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">hoststr</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%2f</span><span class="s1">&#39;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">/api/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">hoststr</span><span class="p">,</span> <span class="mi">15672</span><span class="p">,</span> <span class="s1">&#39;queues&#39;</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%2f</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">))</span>
        <span class="n">jdata</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">jdata</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">qdata</span> <span class="o">=</span> <span class="n">jdata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;message_stats&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qdata</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">qdata</span></div>
        
<div class="viewcode-block" id="RMQDriver.printStatus"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.printStatus">[docs]</a>    <span class="k">def</span> <span class="nf">printStatus</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Print the driver status.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::printStatus&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">RMQDriver</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">printStatus</span><span class="p">()</span>
        <span class="n">qdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_message_stats</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">qdata</span><span class="p">:</span>
            <span class="n">qdata</span> <span class="o">=</span> <span class="n">pformat</span><span class="p">(</span><span class="n">qdata</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="s2">&quot;: server info:</span><span class="se">\n</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">qdata</span><span class="p">)</span></div>

    <span class="c1"># RMQ PROPERTIES</span>
<div class="viewcode-block" id="RMQDriver.on_nmsg_request"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_nmsg_request">[docs]</a>    <span class="k">def</span> <span class="nf">on_nmsg_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_frame</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform once the queue is declared for message count.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_n_msg</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">method_frame</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_n_msg</span> <span class="o">=</span> <span class="n">method_frame</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">message_count</span></div>
                
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">n_rmq_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;int: Number of messages in the queue.&quot;&quot;&quot;</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_n_msg</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_nmsg_request</span><span class="p">,</span>
                                       <span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
                                       <span class="n">exclusive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclusive</span><span class="p">,</span>
                                       <span class="n">auto_delete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                       <span class="n">passive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Wait for queue to be declared passively</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
            <span class="n">timeout</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleeptime</span>
        <span class="c1"># Return result</span>
        <span class="n">n_msg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_msg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">n_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_n_msg</span>
        <span class="k">return</span> <span class="n">n_msg</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">creds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;:class:`pika.credentials.PlainCredentials`: Server credentials.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">pika</span><span class="o">.</span><span class="n">PlainCredentials</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">passwd</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">connection_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;:class:`pika.connection.ConnectionParameters`: Connection</span>
<span class="sd">        parameters.&quot;&quot;&quot;</span>
        <span class="n">kws</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">credentials</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">creds</span><span class="p">,</span>
                   <span class="n">heartbeat_interval</span><span class="o">=</span><span class="mi">120</span><span class="p">,</span>
                   <span class="n">connection_attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kws</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">host</span>
        <span class="k">return</span> <span class="n">pika</span><span class="o">.</span><span class="n">ConnectionParameters</span><span class="p">(</span><span class="o">**</span><span class="n">kws</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;bool: True if connection ready for messages, False otherwise.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">is_closing</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_stable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;bool: True if the connection ready for messages and not about to</span>
<span class="sd">        close. False otherwise.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># CONNECTION</span>
<div class="viewcode-block" id="RMQDriver.connect"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.connect">[docs]</a>    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Establish the connection.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">times_connected</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">pika</span><span class="o">.</span><span class="n">SelectConnection</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection_parameters</span><span class="p">,</span>
            <span class="n">on_open_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_connection_open</span><span class="p">,</span>
            <span class="n">on_open_error_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_connection_open_error</span><span class="p">,</span>
            <span class="n">stop_ioloop_on_close</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.on_connection_open"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_connection_open">[docs]</a>    <span class="k">def</span> <span class="nf">on_connection_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_connection</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions that must be taken when the connection is opened.</span>
<span class="sd">        Add the close connection callback and open the RabbitMQ channel.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Connection opened&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">add_on_close_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_connection_closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">open_channel</span><span class="p">()</span></div>

<div class="viewcode-block" id="RMQDriver.on_connection_open_error"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_connection_open_error">[docs]</a>    <span class="k">def</span> <span class="nf">on_connection_open_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_connection</span><span class="p">):</span>  <span class="c1"># pragma: debug</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions that must be taken when the connection fails to open.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Connection could not be opened&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Could not connect.&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.on_connection_closed"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_connection_closed">[docs]</a>    <span class="k">def</span> <span class="nf">on_connection_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions that must be taken when the connection is closed. Set the</span>
<span class="sd">        channel to None. If the connection is meant to be closing, stop the</span>
<span class="sd">        IO loop. Otherwise, wait 5 seconds and try to reconnect.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::on_connection_closed code </span><span class="si">%d</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span>
                       <span class="n">reply_text</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="ow">or</span> <span class="n">reply_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Connection closed, reopening in </span><span class="si">%f</span><span class="s1"> seconds: (</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">sleeptime</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">add_timeout</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sleeptime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconnect</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.reconnect"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.reconnect">[docs]</a>    <span class="k">def</span> <span class="nf">reconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Try to re-establish a connection and resume a new IO loop.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::reconnect()&#39;</span><span class="p">)</span>
        <span class="c1"># This is the old connection IOLoop instance, stop its ioloop</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>
                <span class="c1"># Create a new connection</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
                <span class="c1"># There is now a new connection, needs a new ioloop to run</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">start</span><span class="p">()</span></div>

    <span class="c1"># CHANNEL</span>
<div class="viewcode-block" id="RMQDriver.open_channel"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.open_channel">[docs]</a>    <span class="k">def</span> <span class="nf">open_channel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Open a RabbitMQ channel.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Creating a new channel&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">channel</span><span class="p">(</span><span class="n">on_open_callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">on_channel_open</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.on_channel_open"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_channel_open">[docs]</a>    <span class="k">def</span> <span class="nf">on_channel_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform after a channel is opened. Add the channel</span>
<span class="sd">        close callback and setup the exchange.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Channel opened&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">add_on_close_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_channel_closed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_exchange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.on_channel_closed"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_channel_closed">[docs]</a>    <span class="k">def</span> <span class="nf">on_channel_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform when the channel is closed. Close the</span>
<span class="sd">        connection.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::channel </span><span class="si">%i</span><span class="s1"> was closed: (</span><span class="si">%s</span><span class="s1">) </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
                       <span class="n">channel</span><span class="p">,</span> <span class="n">reply_code</span><span class="p">,</span> <span class="n">reply_text</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">channel</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">connection</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

    <span class="c1"># EXCHANGE</span>
<div class="viewcode-block" id="RMQDriver.setup_exchange"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.setup_exchange">[docs]</a>    <span class="k">def</span> <span class="nf">setup_exchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exchange_name</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Setup the exchange.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Declaring exchange </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">exchange_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">exchange_declare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_exchange_declareok</span><span class="p">,</span>
                                      <span class="n">exchange</span><span class="o">=</span><span class="n">exchange_name</span><span class="p">,</span> <span class="n">auto_delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.on_exchange_declareok"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_exchange_declareok">[docs]</a>    <span class="k">def</span> <span class="nf">on_exchange_declareok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_frame</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform once an exchange is succesfully declared.</span>
<span class="sd">        Set up the queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Exchange declared&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_queue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span></div>

    <span class="c1"># QUEUE</span>
<div class="viewcode-block" id="RMQDriver.setup_queue"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.setup_queue">[docs]</a>    <span class="k">def</span> <span class="nf">setup_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Set up the message queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Declaring queue </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">queue_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">queue_name</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exclusive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_declare</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_queue_declareok</span><span class="p">,</span>
                                   <span class="n">queue</span><span class="o">=</span><span class="n">queue_name</span><span class="p">,</span>
                                   <span class="n">exclusive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exclusive</span><span class="p">,</span>
                                   <span class="n">auto_delete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="RMQDriver.on_queue_declareok"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_queue_declareok">[docs]</a>    <span class="k">def</span> <span class="nf">on_queue_declareok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method_frame</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform once the queue is succesfully declared. Bind</span>
<span class="sd">        the queue.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Binding&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q_obj</span> <span class="o">=</span> <span class="n">method_frame</span><span class="o">.</span><span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">method_frame</span><span class="o">.</span><span class="n">method</span><span class="o">.</span><span class="n">queue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on_bindok</span><span class="p">,</span>
                                <span class="n">exchange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span>
                                <span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
                                <span class="n">routing_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">routing_key</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="RMQDriver.on_bindok"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.on_bindok">[docs]</a>    <span class="k">def</span> <span class="nf">on_bindok</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">unused_frame</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Actions to perform once the queue is succesfully bound. Start</span>
<span class="sd">        consuming messages.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::Queue bound&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_opening</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_communication</span><span class="p">()</span></div>

<div class="viewcode-block" id="RMQDriver.purge_queue"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.purge_queue">[docs]</a>    <span class="k">def</span> <span class="nf">purge_queue</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Remove all messages from the associated queue.&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_purge</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span></div>

    <span class="c1"># GENERAL</span>
<div class="viewcode-block" id="RMQDriver.start_communication"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.start_communication">[docs]</a>    <span class="k">def</span> <span class="nf">start_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Start sending/receiving messages.&quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="RMQDriver.stop_communication"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.stop_communication">[docs]</a>    <span class="k">def</span> <span class="nf">stop_communication</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remove_queue</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Stop sending/receiving messages.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::stop_communication&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">remove_queue</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::stop_communication: unbinding queue&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="s1">&#39;Unbinding queue&#39;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_unbind</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
                                              <span class="n">exchange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">queue_delete</span><span class="p">(</span><span class="n">queue</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::stop_communication: closing channel&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span> <span class="ow">or</span> <span class="n">timeout</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;::stop_commmunication: waiting for connection to close&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
            <span class="n">timeout</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sleeptime</span></div>

    <span class="c1"># UTILITIES</span>
<div class="viewcode-block" id="RMQDriver.rmq_send"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.rmq_send">[docs]</a>    <span class="k">def</span> <span class="nf">rmq_send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Send a message smaller than maxMsgSize to the RMQ queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (str): The message to be sent.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the message was sent succesfully. False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">backwards</span><span class="o">.</span><span class="n">assert_bytes</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closing</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;::send </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            <span class="k">assert</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">maxMsgSize</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;::send </span><span class="si">%d</span><span class="s2">  NO CHANNEL&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">channel</span><span class="o">.</span><span class="n">basic_publish</span><span class="p">(</span>
                    <span class="n">exchange</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">exchange</span><span class="p">,</span> <span class="n">routing_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">queue</span><span class="p">,</span>
                    <span class="n">body</span><span class="o">=</span><span class="n">data</span><span class="p">,</span> <span class="n">mandatory</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;::send </span><span class="si">%d</span><span class="s2"> : exception </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                          <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="RMQDriver.rmq_send_nolimit"><a class="viewcode-back" href="../../../cis_interface.drivers.html#cis_interface.drivers.RMQDriver.RMQDriver.rmq_send_nolimit">[docs]</a>    <span class="k">def</span> <span class="nf">rmq_send_nolimit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Send a message smaller than maxMsgSize to the RMQ queue.</span>

<span class="sd">        Args:</span>
<span class="sd">            data (str): The message to be sent.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the message was sent succesfully. False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;::send_nolimit </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
        <span class="n">prev</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmq_send</span><span class="p">(</span><span class="n">backwards</span><span class="o">.</span><span class="n">unicode2bytes</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%ld</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">prev</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="nb">next</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">prev</span> <span class="o">+</span> <span class="n">maxMsgSize</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rmq_send</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">prev</span><span class="p">:</span><span class="nb">next</span><span class="p">])</span>
                <span class="n">prev</span> <span class="o">=</span> <span class="nb">next</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="p">:</span>  <span class="c1"># pragma: debug</span>
                    <span class="k">break</span>
        <span class="k">return</span> <span class="n">ret</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Meagan Lang, David Raila.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.5.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
    </div>

    

    
  </body>
</html>